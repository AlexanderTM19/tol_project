{% extends 'core/administrador.html' %}
{% load static %}

{% block title %}Estadísticas{% endblock %}

{% block extra_css %}
<style>
  .stat-card { border: 0; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
  .stat-icon { width: 42px; height: 42px; border-radius: 10px; display:flex; align-items:center; justify-content:center; }
  .wallet-card { border: 0; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,.1); background: linear-gradient(135deg,#111827,#1f2937); color:#fff; }
  /* Pastel gradient for personal income card */
  .wallet-card.light {
    background: linear-gradient(135deg, #c7d2fe, #a7f3d0); /* indigo-200 → emerald-200 */
    color: #0f172a; /* slate-900 for better contrast on pastel */
  }
  .wallet-card.light .subtext { color: #334155; }
  .filter-select { max-width: 220px; }
  .stats-controls { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .stats-controls .form-select-sm,
  .stats-controls .form-control-sm { min-width: 140px; }
  .stats-controls .w-auto { width:auto !important; }
  .card-title-small { font-size: .9rem; color:#6b7280; margin-bottom: .25rem; }
  .value-big { font-size: 1.75rem; font-weight: 700; }
  .subtext { font-size: .85rem; color:#9ca3af; }
  .section-header { font-weight:700; font-size:1.25rem; }
  .legend-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
  /* Fijar altura de contenedores de gráficos para evitar crecimiento infinito */
  .chart-box { position: relative; height: 300px; }
  .chart-box-sm { position: relative; height: 240px; }
  .chart-box > canvas, .chart-box-sm > canvas { width: 100% !important; height: 100% !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Panel de estadísticas</h2>
  </div>

  <!-- Top metrics -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <div class="card stat-card p-3 h-100">
        <div class="d-flex align-items-center">
          <div class="stat-icon bg-primary-subtle text-primary me-3"><i class="bi bi-check2-all"></i></div>
          <div>
            <div class="card-title-small">Servicios realizados</div>
            <div class="value-big">{{ servicios_realizados }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <div class="card stat-card p-3 h-100">
        <div class="d-flex align-items-center">
          <div class="stat-icon bg-warning-subtle text-warning me-3"><i class="bi bi-clock-history"></i></div>
          <div>
            <div class="card-title-small">Servicios por realizar</div>
            <div class="value-big">{{ servicios_por_realizar }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <div class="card stat-card p-3 h-100">
        <div class="d-flex align-items-center">
          <div class="stat-icon bg-danger-subtle text-danger me-3"><i class="bi bi-x-circle"></i></div>
          <div>
            <div class="card-title-small">Servicios cancelados</div>
            <div class="value-big">{{ servicios_cancelados }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <div class="card stat-card p-3 h-100">
        <div class="d-flex align-items-center">
          <div class="stat-icon bg-success-subtle text-success me-3"><i class="bi bi-person-plus"></i></div>
          <div>
            <div class="card-title-small">Clientes nuevos</div>
            <div class="value-big">{{ clientes_nuevos }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-sm-6 col-md-4 col-xl-2">
      <div class="card stat-card p-3 h-100">
        <div class="d-flex align-items-center">
          <div class="stat-icon bg-info-subtle text-info me-3"><i class="bi bi-people"></i></div>
          <div>
            <div class="card-title-small">Clientes frecuentes</div>
            <div class="value-big">{{ clientes_frecuentes }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Sales dynamics / ingresos con filtro -->
    <div class="col-12 col-lg-8">
      <div class="card stat-card p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
          <div class="section-header mb-0">Historial de ingresos</div>
          <div class="stats-controls d-flex align-items-center gap-2">
            <select id="periodFilter" class="form-select form-select-sm filter-select">
              <option value="anio" selected>Año</option>
              <option value="mes">Mes</option>
              <option value="semana">Semana</option>
              <option value="dia">Día</option>
              <option value="rango">Rango</option>
            </select>
            <div id="periodControls" class="d-flex align-items-center gap-2"></div>
            <button id="btnExportExcel" type="button" class="btn btn-sm btn-success">
              <i class="bi bi-file-earmark-excel"></i>
              <span class="ms-1">Exportar a Excel</span>
            </button>
          </div>
        </div>
        <div class="chart-box">
          <canvas id="incomeChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Right column: wallet cards -->
    <div class="col-12 col-lg-4">
      <div class="wallet-card p-4 mb-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="subtext">Total generado por la empresa</div>
            <div class="value-big"><span class="js-clp" data-amount="{{ total_empresa }}"></span></div>
          </div>
          <div><i class="fa-solid fa-wallet fa-2x"></i></div>
        </div>
      </div>
      <div class="wallet-card light p-4">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="subtext">Ingreso personal</div>
            <div class="value-big"><span class="js-clp" data-amount="{{ ingreso_personal }}"></span></div>
          </div>
          <div><i class="fa-solid fa-wallet fa-2x"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <!-- Doughnut chart: distribución de servicios -->
    <div class="col-12 col-lg-4">
      <div class="card stat-card p-3 h-100">
        <div class="section-header mb-2">Distribución de servicios</div>
        <div class="chart-box-sm">
          <canvas id="servicesDonut"></canvas>
        </div>
        <div class="mt-3 small">
          <span class="legend-dot" style="background:#22c55e"></span> Realizados
          <span class="legend-dot ms-3" style="background:#f59e0b"></span> Por realizar
          <span class="legend-dot ms-3" style="background:#ef4444"></span> Cancelados
        </div>
      </div>
    </div>

    <!-- Area chart: actividad general -->
    <div class="col-12 col-lg-8">
      <div class="card stat-card p-3 h-100">
        <div class="section-header mb-2">Actividad general</div>
        <div class="chart-box">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // -------------------------------------------------------------------------
    // 1. OBTENCIÓN DE DATOS DEL BACKEND (DJANGO)
    // -------------------------------------------------------------------------

  const ingresosIniciales = [];
  const etiquetasIniciales = [];

    // Utilidades
    function daysInMonth(year, monthIndex) { // monthIndex 0-11
      return new Date(year, monthIndex + 1, 0).getDate();
    }
    function range(n){ return Array.from({length:n}, (_,i)=>i+1); }

    const ctxIncome = document.getElementById('incomeChart');
    const ctxDonut = document.getElementById('servicesDonut');
    const ctxActivity = document.getElementById('activityChart');

    const primary = '#0ea5e9', secondary = '#6366f1';

    // Formateador CLP
    const fmtCLP = (n) => new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits: 0 }).format(n);

    // -------------------------------------------------------------------------
    // 2. GRÁFICO DE INGRESOS (INCOME CHART)
    // -------------------------------------------------------------------------

    // Income line chart with gradient
    const incomeChart = new Chart(ctxIncome, {
      type: 'bar',
      data: {
        labels: etiquetasIniciales,
        datasets: [{
          label: 'Ingresos (CLP - miles)',
          data: ingresosIniciales,
          backgroundColor: 'rgba(14,165,233,0.25)',
          borderColor: primary,
          borderWidth: 2,
          tension: .3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => ` ${fmtCLP(ctx.raw * 1000)}`
            }
          }
        },
        scales: {
          y: {
            grid: { color: 'rgba(0,0,0,.05)' }, beginAtZero: true,
            title: { display: true, text: 'CLP (miles)' },
            ticks: {
              callback: (val) => fmtCLP(val * 1000)
            }
          },
          x: { grid: { display: false } }
        }
      }
    });

  // Mensaje cuando no hay datos
  const incomeNoDataEl = document.createElement('div');
  incomeNoDataEl.id = 'incomeNoData';
  incomeNoDataEl.className = 'text-center text-muted mt-2';
  incomeNoDataEl.style.display = 'none';
  incomeNoDataEl.textContent = 'No hay datos para este periodo.';
  ctxIncome.parentNode.appendChild(incomeNoDataEl);

    // -------------------------------------------------------------------------
    // 3. LÓGICA DINÁMICA DE ACTUALIZACIÓN (AJAX) - CORREGIDA
    // -------------------------------------------------------------------------

    // Controles dinámicos de periodo
    const periodControls = document.getElementById('periodControls');
    const periodFilter = document.getElementById('periodFilter');
    const currentYear = new Date().getFullYear();
    const years = [currentYear-2, currentYear-1, currentYear, currentYear+1];
    const toISO = (d) => new Date(d).toISOString().slice(0,10);
    const addDays = (d, n) => { const dt = new Date(d); dt.setDate(dt.getDate()+n); return dt; };
    const daysBetweenInclusive = (from, to) => {
      const start = new Date(from), end = new Date(to);
      const ms = end - start; if (isNaN(ms) || ms < 0) return 0;
      return Math.floor(ms / (1000*60*60*24)) + 1;
    };

    /**
     * @param {string} period - anio, mes, semana, dia, rango
     * @param {Object} params - {year, month, date, from1, to1, from2, to2}
     */
    async function updateIncome(period, params){
      const query = new URLSearchParams({ period, ...(params || {}) });
      const url = `/administrador/estadisticas/data/?${query.toString()}`;
      try{
        const res = await fetch(url);
        if(!res.ok){ throw new Error('HTTP ' + res.status); }
        const payload = await res.json();

        const labels = payload.labels || [];
        const datasets = payload.datasets || [];

        const hasData = datasets.length > 0 && datasets.some(ds => Array.isArray(ds.data) && ds.data.some(v => v !== null && v !== 0));
        incomeNoDataEl.style.display = hasData ? 'none' : 'block';

        incomeChart.data.labels = labels;
        if(datasets.length){
          incomeChart.data.datasets = datasets.map((ds, idx)=>({
            label: ds.label || (`Serie ${idx+1}`),
            data: ds.data || [],
            backgroundColor: idx === 0 ? 'rgba(14,165,233,0.25)' : 'rgba(99,102,241,0.25)',
            borderColor: idx === 0 ? primary : secondary,
            borderWidth: 2,
            tension: .3
          }));
        } else {
          incomeChart.data.datasets = [{ label: 'Ingresos (CLP - miles)', data: [] }];
        }
        incomeChart.options.plugins.legend.display = incomeChart.data.datasets.length > 1;
        incomeChart.update();
      }catch(err){
        console.error('Error fetching estadisticas data', err);
        incomeNoDataEl.style.display = 'block';
        incomeChart.data.labels = [];
        incomeChart.data.datasets = [{ label: 'Ingresos (CLP - miles)', data: [] }];
        incomeChart.update();
      }
    }

    // -------------------------------------------------------------------------
    // 4. GENERACIÓN DE CONTROLES (Sin cambios, esto está correcto)
    // -------------------------------------------------------------------------
    
    function renderControls(period){
      let html = '';
      const today = new Date();
      const weekAgo = addDays(today, -6);
      const defaultFrom = toISO(weekAgo);
      const defaultTo = toISO(today);

      if(period === 'anio'){
        html = `<select id="ctrlYear" class="form-select form-select-sm w-auto flex-shrink-0">${years.map(y=>`<option value="${y}" ${y===currentYear? 'selected':''}>${y}</option>`).join('')}</select>`;
        periodControls.innerHTML = html;
        document.getElementById('ctrlYear').addEventListener('change', (e)=>{
          updateIncome('anio', {year: e.target.value});
        });
        updateIncome('anio', {year: document.getElementById('ctrlYear').value});
      } else if(period === 'mes'){
        const currentMonth = today.getMonth() + 1;
        html = `<select id=\"ctrlYear\" class=\"form-select form-select-sm w-auto flex-shrink-0\">${years.map(y=>`<option value=\"${y}\" ${y===currentYear? 'selected':''}>${y}</option>`).join('')}</select>`+
               `<select id=\"ctrlMonth\" class=\"form-select form-select-sm w-auto flex-shrink-0\">` +
               ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'].map((m,i)=>
                 `<option value=\"${i+1}\" ${i+1===currentMonth?'selected':''}>${m}</option>`
               ).join('') +
               `</select>`;
        periodControls.innerHTML = html;
        const apply = ()=> updateIncome('mes', {year: document.getElementById('ctrlYear').value, month: document.getElementById('ctrlMonth').value});
        document.getElementById('ctrlYear').addEventListener('change', apply);
        document.getElementById('ctrlMonth').addEventListener('change', apply);
        apply();
      } else if(period === 'semana'){
        html = `<select id=\"ctrlYear\" class=\"form-select form-select-sm w-auto flex-shrink-0\">${years.map(y=>`<option value=\"${y}\" ${y===currentYear? 'selected':''}>${y}</option>`).join('')}</select>`+
               `<select id=\"ctrlWeek\" class=\"form-select form-select-sm w-auto flex-shrink-0\">${range(52).map(w=>`<option value=\"${w}\">Semana ${w}</option>`).join('')}</select>`;
        periodControls.innerHTML = html;
        const apply = ()=> updateIncome('semana', {year: document.getElementById('ctrlYear').value, week: document.getElementById('ctrlWeek').value});
        document.getElementById('ctrlYear').addEventListener('change', apply);
        document.getElementById('ctrlWeek').addEventListener('change', apply);
        apply();
      } else if(period === 'dia'){
        const todayISO = toISO(today);
        html = `<input id=\"ctrlDate\" type=\"date\" class=\"form-control form-control-sm w-auto flex-shrink-0\" value=\"${todayISO}\" />`;
        periodControls.innerHTML = html;
        const apply = ()=> updateIncome('dia', {date: document.getElementById('ctrlDate').value});
        document.getElementById('ctrlDate').addEventListener('change', apply);
        apply();
      } else if(period === 'rango'){
        html = `
          <div class=\"d-flex align-items-center gap-2 flex-wrap\">
            <span class=\"small text-muted\">Rango 1</span>
            <input id=\"range1From\" type=\"date\" class=\"form-control form-control-sm w-auto\" value=\"${defaultFrom}\" />
            <span class=\"small\">a</span>
            <input id=\"range1To\" type=\"date\" class=\"form-control form-control-sm w-auto\" value=\"${defaultTo}\" />
            <div class=\"form-check form-check-inline ms-2\">
              <input class=\"form-check-input\" type=\"checkbox\" id=\"compareToggle\">
              <label class=\"form-check-label small\" for=\"compareToggle\">Comparar con otro rango</label>
            </div>
            <div id=\"compareControls\" class=\"d-none d-flex align-items-center gap-2 flex-wrap\">
              <span class=\"small text-muted\">Rango 2</span>
              <input id=\"range2From\" type=\"date\" class=\"form-control form-control-sm w-auto\" />
              <span class=\"small\">a</span>
              <input id=\"range2To\" type=\"date\" class=\"form-control form-control-sm w-auto\" />
            </div>
            <button id=\"applyRange\" class=\"btn btn-sm btn-primary\">Aplicar</button>
          </div>
        `;
        periodControls.innerHTML = html;
        const compareToggle = document.getElementById('compareToggle');
        const compareControls = document.getElementById('compareControls');
        compareToggle.addEventListener('change', (e)=>{
          compareControls.classList.toggle('d-none', !e.target.checked);
        });
        const apply = ()=>{
          const from1 = document.getElementById('range1From').value;
          const to1 = document.getElementById('range1To').value;
          const useCompare = document.getElementById('compareToggle').checked;
          const from2 = useCompare ? document.getElementById('range2From').value : null;
          const to2 = useCompare ? document.getElementById('range2To').value : null;
          updateIncome('rango', {from1, to1, from2, to2});
        };
        document.getElementById('applyRange').addEventListener('click', apply);
        
        // Agregar listeners para el rango 1 para que se actualice dinámicamente
        document.getElementById('range1From').addEventListener('change', apply);
        document.getElementById('range1To').addEventListener('change', apply);

        apply();
      }
    }

    periodFilter.addEventListener('change', (e)=> renderControls(e.target.value));
    
    // ⭐ Asegurar que la lógica se ejecute al cargar la página
    if (periodFilter.value) {
      renderControls(periodFilter.value);
    } else {
      // Si no tiene valor por defecto, inicializar en 'anio'
      periodFilter.value = 'anio';
      renderControls('anio');
    }

    // -------------------------------------------------------------------------
    // 5. OTROS GRÁFICOS (DONUT Y ACTIVITY)
    // -------------------------------------------------------------------------

    // Formateo de montos en billeteras a CLP
    document.querySelectorAll('.js-clp').forEach(el => {
      const val = parseFloat(el.dataset.amount || 0);
      el.textContent = fmtCLP(val);
    });

    // Donut chart for service distribution (Ya usa datos de Django)
    new Chart(ctxDonut, {
      type: 'doughnut',
      data: {
        labels: ['Realizados','Por realizar','Cancelados'],
        datasets: [{
          data: [{{ servicios_realizados }}, {{ servicios_por_realizar }}, {{ servicios_cancelados }}],
          backgroundColor: ['#22c55e','#f59e0b','#ef4444']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        cutout: '70%'
      }
    });

    // Area chart for overall activity (Mantiene datos estáticos)
    new Chart(ctxActivity, {
      type: 'line',
      data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [{
          label: 'Actividad',
          data: [5,9,7,12,15,18,21,25,23,19,13,10],
          fill: true,
          backgroundColor: 'rgba(99,102,241,0.18)',
          borderColor: secondary,
          tension: .35,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.05)'} }, x: { grid:{ display:false } } }
      }
    });
</script>
{% endblock %}
